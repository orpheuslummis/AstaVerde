# Local Development Guide

## Quick Start

```bash
# Start complete local dev environment (contracts + webapp + test data)
npm run dev

# Or use the startup script:
./start-local.sh

# This single command:
# 1. Starts local Hardhat node
# 2. Deploys all contracts
# 3. Sets up test data (batches, tokens, vault scenarios)
# 4. Starts webapp on http://localhost:3000
# 5. Provides real-time status monitoring
```

## ⚠️ Important Notes

**The local environment must be restarted each time you want to use it.** This is because:

- Hardhat node doesn't persist state between restarts
- Contract addresses change with each deployment
- Test data needs to be re-seeded

**MetaMask will cache old data**, so after restarting:

1. Switch to a different network and back to Localhost 8545
2. Or go to Settings → Advanced → Clear activity tab data

## Environment Variables

### Contract Addresses (Auto-generated by `npm run dev`)

```
ASTAVERDE_CONTRACT_ADDRESS=0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512
USDC_ADDRESS=0x5FbDB2315678afecb367f032d93F642f64180aa3
ECOSTABILIZER_CONTRACT_ADDRESS=0xCf7Ed3AccA5a467e9e704C703E8D87F634fB0Fc9
SCC_CONTRACT_ADDRESS=0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0
```

### Test Accounts (Hardhat defaults)

```
Deployer: 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266
Alice:    0x70997970C51812dc3A010C7d01b50e0d17dc79C8
Bob:      0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
Charlie:  0x90F79bf6EB2c4f870365E785982E1f101E93b906
Dave:     0x15d34AAf54267DB7D7c367839AAf71A00a2C6A65
```

## Available Commands

### Development Scenarios

```bash
# Complete dev environment with all features
npm run dev

# Specific scenarios:
npm run dev:basic       # Basic marketplace
npm run dev:marketplace # Active marketplace with various states
npm run dev:vault       # Vault functionality testing
npm run dev:local       # Local full stack (node + deploy + webapp)
```

### Quick QA Testing

```bash
npm run qa:status  # Ultra-fast health check (~400ms)
npm run qa:fast    # Critical path testing (~450ms)
npm run qa:full    # Comprehensive testing with reports
```

### Contract Operations

```bash
# Compile contracts
npm run compile

# Run tests
npm run test
npm run coverage

# Clean and rebuild
npm run clean
```

### Webapp Development

```bash
npm run webapp:dev    # Start Next.js dev server only
npm run webapp:build  # Build for production
```

### Minting New Batches

#### Simple Script (Recommended)

```bash
# Mint 2 tokens
node scripts/mint-local-batch.js 2

# Mint 5 tokens
node scripts/mint-local-batch.js 5
```

#### Original Script (requires .env setup)

```bash
npm run task:mint:local
```

### Linting & Formatting

```bash
npm run lint              # All linting
npm run lint:sol          # Solidity only
npm run prettier:check    # Check formatting
npm run prettier:write    # Fix formatting
```

### Build Verification

```bash
npm run build:all        # Compile + test + webapp:build
npm run verify:deploy    # Full pre-deployment verification
```

## Common Tasks

### 1. Add More Test Tokens

```bash
node scripts/mint-local-batch.js 3
```

### 2. Reset Everything

```bash
# Stop current processes (Ctrl+C)
# Then restart:
npm run dev
```

### 3. Check System Status

```bash
npm run qa:status
```

### 4. View Contract Interactions

The dev environment logs all contract interactions in real-time.
Look for transaction details in the terminal running `npm run dev`.

## File Structure

```
/scripts/
  ├── all-in-one-dev.js        # Main dev environment orchestrator
  ├── dev-environment.js        # Scenario setup scripts
  ├── mint-local-batch.js       # Simple local minting
  ├── fast-qa.js               # Quick testing
  └── status-check.js          # Health monitoring

/webapp/
  ├── src/config/environment.ts  # Env-driven chain/addresses (current)
  ├── src/config/constants.ts    # Frontend constants (current)
  ├── src/app.config.ts          # Deprecated (kept for backward-compat)
  └── src/config/
      └── local-dev.json       # Local contract addresses

/contracts/                    # Smart contracts
  ├── AstaVerde.sol            # Phase 1: NFT marketplace
  ├── EcoStabilizer.sol        # Phase 2: Vault system
  └── StabilizedCarbonCoin.sol # Phase 2: SCC token
```

## Troubleshooting

### Issue: "Contract not found" errors

**Solution:** Ensure `npm run dev` is running and contracts are deployed.

### Issue: Wallet connection problems

**Solution:**

1. Use MetaMask
2. Add localhost network (Chain ID: 31337)
3. Import test account: `0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80`

### Issue: Transaction failures

**Solution:** Check wallet has ETH and USDC. The dev environment provides both automatically.

### Issue: IPFS metadata errors

**Solution:** Already fixed - local dev uses mock metadata, no external IPFS needed.

## Key Features in Dev Environment

### Phase 1 (Marketplace)

- Dutch auction pricing
- Batch minting and purchasing
- Token redemption
- Producer payments

### Phase 2 (Vault)

- Deposit NFTs as collateral
- Receive 20 SCC per NFT
- Withdraw NFTs by repaying SCC
- No liquidation mechanism

## Testing Flows

### Buy NFTs

1. Connect wallet (account gets 100,000 USDC automatically)
2. Go to Market page
3. Select batch and quantity
4. Click Buy

### Use Vault

1. Go to My Eco Assets
2. Select unredeemed NFTs
3. Click "Deposit to Vault"
4. Receive 20 SCC per NFT

### Redeem Tokens

1. Go to My Eco Assets
2. Select tokens to redeem
3. Click "Redeem Selected"
4. Tokens marked as redeemed (can't be deposited to vault)

## Notes

- All contract addresses are deterministic in local development
- Test accounts are pre-funded with ETH and USDC
- Mock IPFS data is used (no external dependencies)
- Hot reload enabled for webapp changes
- Contract changes require restart of `npm run dev`
