# AGENTS.md — AI Assistant Guide for AstaVerde

This repository uses Hardhat (contracts), a Next.js webapp, and helper scripts. This guide is for any coding agent (Claude Code, ChatGPT/Copilot Chat, etc.) working in this repo. It replaces and modernizes the older CLAUDE.md.

## Quick Commands

- Compile: `npm run compile` (also writes `webapp/src/config/AstaVerde.json` ABI)
- Typechain: `npm run typechain`
- Clean: `npm run clean`
- Tests: `npm run test`
- Coverage: `npm run coverage`
- Lint: `npm run lint` (JS/TS + Solidity + Prettier)
- Format: `npm run prettier:write`
- QA (fast status → full localhost): `npm run qa:status` → `npm run qa:fast` → `npm run qa:full`
- Local dev stack (HH node + deploy + webapp): `npm run dev:local` (webapp on 3000; may fall back to 3001)
- Sepolia webapp (uses `webapp/.env.sepolia`): `npm run dev:sepolia` (webapp on 3002)
- Deploy (scripts with validation): `npm run deploy:testnet` | `npm run deploy:mainnet` | `npm run deploy:safe`
- ABI sanity check: `npm run validate:abis`

## Project Map

- `contracts/` — Solidity: `AstaVerde.sol` (v1 marketplace), `EcoStabilizer.sol` (v2 vault), `StabilizedCarbonCoin.sol` (SCC), `IAstaVerde.sol`, test helpers.
- `scripts/` — Local stack, QA, deployment, validation (e.g., `start-local.js`, `dev-sepolia.js`, `deploy-with-validation.js`, `validate-abis.js`).
- `deploy/` + `deployments/` — Hardhat Deploy scripts and artifacts.
- `webapp/` — Next.js 14 + TS + Tailwind; on-chain via wagmi/viem.
- `docs/` — Up‑to‑date guides: `DEV_GUIDE.md`, `TESTING.md`, `DEPLOYMENT.md`, `QA_TESTING.md`, `SSC_PLAN.md`.
- `test/` — Mocha/Chai TS tests and docs: `AstaVerde.test.ts`, `EcoStabilizer.test.ts`, `StabilizedCarbonCoin.test.ts`, `Integration.test.ts`, plus `TESTING_GUIDE.md` and `INTEGRATION_TESTING.md`.

## Current Architecture (2025‑08‑27)

- v1 (2024‑11‑15): Dutch‑auction ERC‑1155 marketplace on Base mainnet.
- v2 (2025‑08‑25): EcoStabilizer vault and SCC token.
    - Fixed issuance: 20 SCC per NFT (`SCC_PER_ASSET = 20e18`).
    - No liquidations: Withdraw exact NFT by repaying 20 SCC.
    - Only un‑redeemed NFTs acceptable as collateral (checked via `IAstaVerde`).
    - Access control: SCC `MINTER_ROLE` granted exclusively to the vault.
    - Gas targets: deposit <150k, withdraw <120k.

## Local And Testnet Environments

- Local full stack: `npm run dev:local`
    - Starts Hardhat node (8545) → deploys → writes `webapp/.env.local` → starts webapp on 3000.
    - If 3000 is busy, falls back to 3001. Stop via Ctrl+C or `npm run dev:local:stop`.

- Base Sepolia webapp: `npm run dev:sepolia`
    - Requires `webapp/.env.sepolia` with deployed addresses.
    - Starts webapp on port 3002 and injects `.env.sepolia` vars.

### RPC Endpoints

- Prefer using direct RPC URLs to avoid rate limits: set `BASE_SEPOLIA_RPC_URL` and/or `BASE_MAINNET_RPC_URL` in `.env.local`.
- If not set, the deploy scripts/build use Alchemy via `RPC_API_KEY`; the `demo` key will 429 on live deploys.

## Webapp Configuration (updated)

- Use `webapp/src/config/environment.ts` and `webapp/src/config/constants.ts` for addresses and constants.
- `webapp/src/app.config.ts` is deprecated (kept only for backward‑compat; do not target it).
- Env files:
    - Local: `webapp/.env.local` (auto‑generated by `dev:local`).
    - Sepolia: `webapp/.env.sepolia` (manual; see `scripts/dev-sepolia.js` for required keys; example: `webapp/.env.sepolia.example`).
    - Mainnet (optional): `webapp/.env.mainnet` for production config (example: `webapp/.env.mainnet.example`).
    - Root secrets (ignored): `.env.sepolia` / `.env.mainnet` for server‑side keys (examples provided at repo root).
- Contract ABIs consumed by the webapp live in `webapp/src/config/*.json`.
    - `npm run compile` refreshes `AstaVerde.json`.
    - Use `npm run validate:abis` to sanity‑check other ABIs and config.

## Webapp Commands

- From `webapp/` directory:
    - `npm run dev` — Start Next.js dev server (uses current `.env.*`).
    - `npm run dev:turbo` — Start with Turbo mode.
    - `npm run build` — Production build.
    - `npm run lint` | `npm run lint:fix` — Lint and auto‑fix.

## Common Workflows

- Contract change:
    1. `npm run compile`
    2. `npm run validate:abis`
    3. `npm run test` (and optionally `npm run coverage`)

- Webapp change:
    - Run `npm run dev:local` (or `npm run dev:sepolia`) and iterate in `webapp/`.
    - Lint/build: `cd webapp && npm run lint && npm run build`.

- Deploy:
    - Sepolia: `npm run deploy:testnet` → update `webapp/.env.sepolia` → `npm run dev:sepolia`.
    - Mainnet: `npm run deploy:mainnet` (uses `scripts/deploy-with-validation.js`).

## Testing Overview

- Unit/integration tests in `test/` (Mocha/Chai, ethers‑v6, Hardhat Network).
- Key suites: `AstaVerde.test.ts`, `EcoStabilizer.test.ts`, `StabilizedCarbonCoin.test.ts`, `Integration.test.ts`.
- Docs: `docs/TESTING.md`, `test/TESTING_GUIDE.md`, `test/INTEGRATION_TESTING.md`.
- Quick QA: `npm run qa:status` → `npm run qa:fast` → `npm run qa:full`.

## Guardrails For Agents

- Don’t hand‑edit webapp ABI JSON; prefer `npm run compile` and `npm run validate:abis`.
- Keep addresses in env files, not hardcoded in source.
- Respect formatting/linting before commits: `npm run prettier:write` and `npm run lint`.
- For local flows, prefer `npm run dev:local` over ad‑hoc node/hardhat commands.
- When touching deployment, prefer `deploy-with-validation.js` scripts over raw Hardhat CLI.

## Tickets

- Active vs archived: Active tickets live in `tickets/`. Completed tickets move to `tickets/archive/`. Location is the status; no extra tracker.
- Working a ticket: Read and verify the issue, implement or confirm fixed, run tests, then archive on completion.
- Move commands: If fixed without code changes: `mv tickets/XXX-*.md tickets/archive/XXX-fixed-*.md`. For won’t fix: `mv ... tickets/archive/XXX-wontfix-*.md`.
- Naming: `XXX-category-description.md` where `XXX` is three digits. Categories: `security`, `enhancement`, `refactor`, `cleanup`, `doc`, `test`.
- Priority field: Look for `**Priority**:` with values `CRITICAL` (security/slippage/MEV), `HIGH` (major functionality/UX), `MEDIUM`, `LOW`.
- Focus areas: Security validations, user‑facing errors/UX, and code quality/cleanup.

## What Changed vs CLAUDE.md

- Webapp config now uses `src/config/environment.ts` and `src/config/constants.ts`; `src/app.config.ts` is deprecated.
- Verified script names and ports; removed non‑existent commands (e.g., `dev:both`).
- Updated doc links (use `docs/DEV_GUIDE.md`, `docs/TESTING.md`, `docs/DEPLOYMENT.md`, `docs/QA_TESTING.md`, `docs/SSC_PLAN.md`; integration/testing docs also live in `test/`).
- Clarified ABI handling and added `npm run validate:abis` as a first‑class check.
- Confirmed v2 release date (2025‑08‑25) and current gas targets.

## Pointers

- Need a quick sanity check? `npm run qa:status`.
- Local minting/example data: see `scripts/mint-local-batch.js` and `scripts/seed-local.js`.
- Events/monitoring: `scripts/events/`.
